{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-4 text-primary">Agent-wise Leads Overview</h2>

  <!-- Write Email Button -->
  <div class="mb-4 d-flex align-items-center gap-3">
    <button class="btn btn-primary" id="openComposeModalBtn" type="button" aria-label="Write Bulk Email">
      <i class="bi bi-pencil-square"></i> Write Email
    </button>
  </div>

  <!-- Agent Filter Section -->
  <div class="mb-4">
    <h5>Select Agents:</h5>
    {% for agent in leads_by_agent %}
      <div class="form-check form-check-inline">
        <input class="form-check-input agent-toggle" type="checkbox" id="agent_{{ loop.index }}" data-agent="{{ agent }}" aria-label="Toggle leads for agent {{ agent }}">
        <label class="form-check-label" for="agent_{{ loop.index }}">{{ agent }}</label>
      </div>
    {% endfor %}
  </div>

  <!-- Lead Tables by Agent -->
  {% for agent, summary in leads_by_agent.items() %}
    <div class="agent-section mb-4" id="section_{{ agent }}" style="display: none;">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex align-items-center justify-content-between flex-wrap">
          <strong>{{ agent }}</strong>
          <div class="d-flex flex-wrap gap-2 mt-2 mt-sm-0">
            <span class="badge bg-light text-dark">Total: {{ summary.total }}</span>
            <span class="badge bg-success">Interested: {{ summary.interested }}</span>
            <span class="badge bg-danger">Not Interested: {{ summary.not_interested }}</span>
            <span class="badge bg-warning text-dark">Talk to Later: {{ summary.talk_later }}</span>
          </div>
        </div>
        <div class="card-body">
          {% if summary.leads %}
          <div class="table-responsive">
            <table class="table table-bordered table-striped align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>City</th>
                  <th>State</th>
                  <th>Course</th>
                  <th>Status</th>
                  <th>Created At</th>
                  <th>Note for Admin</th>
                </tr>
              </thead>
              <tbody>
                {% for lead in summary.leads %}
                <tr>
                  <td>{{ lead.name }}</td>
                  <td>
                    {{ lead.email or '-' }}
                    {% if lead.email and invalid_emails and lead.email in invalid_emails %}
                      <span class="badge bg-danger ms-2" title="Invalid Email">Invalid Email</span>
                    {% endif %}
                  </td>
                  <td>{{ lead.phone or '-' }}</td>
                  <td>{{ lead.city or '-' }}</td>
                  <td>{{ lead.state or '-' }}</td>
                  <td>{{ lead.course or '-' }}</td>
                  <td>
                    <span class="badge
                    {% if lead.status == 'Interested' %} bg-success
                    {% elif lead.status == 'Not Interested' %} bg-danger
                    {% elif lead.status == 'Talk to Later' %} bg-warning text-dark
                    {% else %} bg-secondary
                    {% endif %}">
                    {{ lead.status or 'N/A' }}
                    </span>
                  </td>
                  <td>{{ lead.created_at.strftime('%Y-%m-%d %H:%M') if lead.created_at else '-' }}</td>
                  <td>
                    {% if lead.note_to_admin %}
                      <button type="button" class="btn btn-link p-0 note-view-btn" data-note="{{ lead.note_to_admin|e }}" title="View full note">
                        View Note
                      </button>
                    {% else %}
                      <span class="text-muted small">No note</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
            <p class="text-muted mb-0">No leads assigned.</p>
          {% endif %}
        </div>
      </div>
    </div>
  {% endfor %}
</div>

<!-- Note Modal -->
<div class="modal fade" id="noteModal" tabindex="-1" aria-labelledby="noteModalLabel" aria-hidden="true" >
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="noteModalLabel">Agent's Note</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="noteModalBody" style="white-space: pre-wrap; word-break: break-word;"></div>
    </div>
  </div>
</div>

<!-- Compose Bulk Email Modal -->
<div class="modal fade" id="composeBulkEmailModal" tabindex="-1" aria-labelledby="composeBulkEmailModalLabel" aria-hidden="true" >
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="composeBulkEmailModalLabel">Write Bulk Email</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="bulkEmailForm" autocomplete="off">
          <div class="mb-3">
            <label for="bulkEmailAgentSelect" class="form-label">Send Email To</label>
            <select id="bulkEmailAgentSelect" class="form-select" aria-label="Select agent or all leads">
              <option value="__all__" selected>All Leads</option>
              {% for agent in leads_by_agent %}
                <option value="{{ agent }}">{{ agent }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label for="bulkEmailSubject" class="form-label">Subject</label>
            <input type="text" class="form-control" id="bulkEmailSubject" placeholder="Enter email subject" required aria-required="true" />
          </div>
          <div class="mb-3">
            <label for="bulkEmailBody" class="form-label">Message Body</label>
            <textarea class="form-control" id="bulkEmailBody" rows="6" placeholder="Enter email message" required aria-required="true"></textarea>
          </div>
          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary" aria-label="Send bulk email">
              <i class="bi bi-envelope"></i> Send Email
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055" >
  <div id="toast" class="toast align-items-center text-white bg-primary border-0" role="alert" aria-live="polite" aria-atomic="true" >
    <div class="d-flex">
      <div id="toast-body" class="toast-body">Action completed.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {

    // Toggle agent lead display
    document.querySelectorAll(".agent-toggle").forEach(toggle => {
      toggle.addEventListener("change", function() {
        const section = document.getElementById("section_" + this.dataset.agent);
        if (section) {
          section.style.display = this.checked ? "block" : "none";
        }
      });
    });

    // Show note modal
    document.querySelectorAll('.note-view-btn').forEach(button => {
      button.addEventListener('click', () => {
        const note = button.dataset.note || "No note available.";
        const modalBody = document.getElementById('noteModalBody');
        modalBody.textContent = note;
        const noteModal = new bootstrap.Modal(document.getElementById('noteModal'));
        noteModal.show();
      });
    });

    // Compose bulk email modal
    const composeModal = new bootstrap.Modal(document.getElementById('composeBulkEmailModal'));

    // Open compose modal
    document.getElementById('openComposeModalBtn').addEventListener('click', () => {
      document.getElementById('bulkEmailSubject').value = '';
      document.getElementById('bulkEmailBody').value = '';
      document.getElementById('bulkEmailAgentSelect').value = '__all__';
      composeModal.show();
    });

    // Handle bulk email form submit
    document.getElementById('bulkEmailForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const subject = document.getElementById('bulkEmailSubject').value.trim();
      const body = document.getElementById('bulkEmailBody').value.trim();
      const toAgent = document.getElementById('bulkEmailAgentSelect').value;

      if (!subject || !body) {
        showToast('⚠️ Subject and message body are required');
        return;
      }

      let url = '/admin/send-bulk-email';
      if (toAgent !== '__all__') {
        url = `/admin/send-bulk-email-agent/${encodeURIComponent(toAgent)}`;
      }

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({subject, body}),
        });

        if (!response.ok) {
          showToast('❌ Failed to send bulk emails.');
          return;
        }

        const data = await response.json();
        showToast(`✅ Emails sent: ${data.sent}, skipped: ${data.skipped}.`);
        composeModal.hide();
      } catch (err) {
        console.error(err);
        showToast('❌ Error sending bulk emails.');
      }
    });

  }); // End DOMContentLoaded

  // Toast helper
  function showToast(message) {
    const toastBody = document.getElementById('toast-body');
    toastBody.textContent = message;
    const toast = new bootstrap.Toast(document.getElementById('toast'), {delay: 5000});
    toast.show();
  }
</script>
{% endblock %}
